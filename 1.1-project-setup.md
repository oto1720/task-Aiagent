# Phase 1.1: プロジェクト初期設定 詳細手順

TimeFlowアプリの開発を開始するための詳細なセットアップ手順です。

## 前提条件

- Flutter SDK 3.9.0 以上がインストール済み
- Android Studio または VS Code がインストール済み
- Git がインストール済み
- Node.js 18以上がインストール済み（Firebase CLI用）

## 1. 依存関係の設定（pubspec.yaml更新）

### 1.1 現在のpubspec.yamlのバックアップ

```bash
# 現在の設定をバックアップ
cp pubspec.yaml pubspec.yaml.backup
```

### 1.2 pubspec.yamlの更新

現在のpubspec.yamlに必要な依存関係を追加します：

```yaml
name: task_aiagent
description: "TimeFlow - AIタスク管理アプリ"
publish_to: 'none'
version: 1.0.0+1

environment:
  sdk: ^3.9.0

dependencies:
  flutter:
    sdk: flutter
  cupertino_icons: ^1.0.8
  
  # 状態管理
  flutter_riverpod: ^2.4.0
  riverpod_annotation: ^2.3.3
  
  # Firebase
  firebase_core: ^2.15.0
  firebase_auth: ^4.7.2
  cloud_firestore: ^4.8.4
  firebase_storage: ^11.2.5
  firebase_analytics: ^10.4.5
  cloud_functions: ^4.3.3
  
  # UI/UX
  material_color_utilities: ^0.5.0
  go_router: ^12.1.1
  
  # ローカルストレージ
  shared_preferences: ^2.2.0
  hive: ^2.2.3
  hive_flutter: ^1.1.0
  
  # HTTP通信
  dio: ^5.3.0
  
  # 日時処理
  intl: ^0.18.1
  timezone: ^0.9.2
  
  # カレンダー連携
  google_sign_in: ^6.1.4
  googleapis: ^11.4.0
  device_calendar: ^4.3.1
  
  # 通知
  flutter_local_notifications: ^15.1.0+1
  
  # AI/ML
  tflite_flutter: ^0.10.4
  
  # その他ユーティリティ
  uuid: ^3.0.7
  path_provider: ^2.1.0
  permission_handler: ^10.4.3
  freezed_annotation: ^2.4.1
  json_annotation: ^4.8.1

dev_dependencies:
  flutter_test:
    sdk: flutter
  
  # コード生成
  build_runner: ^2.4.7
  riverpod_generator: ^2.3.9
  hive_generator: ^2.0.1
  freezed: ^2.4.6
  json_serializable: ^6.7.1
  
  # テスト
  mockito: ^5.4.2
  integration_test:
    sdk: flutter
  
  # コード品質
  flutter_lints: ^3.0.0
  very_good_analysis: ^5.1.0

flutter:
  uses-material-design: true
  
  # アセット設定（後で追加）
  # assets:
  #   - assets/images/
  #   - assets/icons/
  
  # フォント設定（後で追加）
  # fonts:
  #   - family: CustomFont
  #     fonts:
  #       - asset: assets/fonts/CustomFont-Regular.ttf
```

### 1.3 依存関係のインストール

```bash
# 依存関係をインストール
flutter pub get

# コード生成の実行
flutter packages pub run build_runner build --delete-conflicting-outputs
```

## 2. Firebaseプロジェクトセットアップ

### 2.1 Firebase CLIのインストール

```bash
# npm経由でFirebase CLIをインストール
npm install -g firebase-tools

# Firebase CLIのバージョン確認
firebase --version
```

### 2.2 Firebaseプロジェクトの作成

```bash
# Firebaseにログイン
firebase login

# 新しいFirebaseプロジェクトを作成（ブラウザで操作）
# プロジェクト名: timeflow-app-[unique-id]
# プロジェクトID: timeflow-app-[unique-id]
```

または、Firebase Consoleで手動作成：
1. https://console.firebase.google.com/ にアクセス
2. 「プロジェクトを追加」をクリック
3. プロジェクト名: `TimeFlow App`
4. プロジェクトID: `timeflow-app-[unique-id]`
5. Googleアナリティクスを有効にする

### 2.3 FlutterFire CLIのセットアップ

```bash
# FlutterFire CLIをインストール
dart pub global activate flutterfire_cli

# PATHに追加されていることを確認
export PATH="$PATH":"$HOME/.pub-cache/bin"

# FlutterFireの設定
flutterfire configure
```

プロンプトで以下を選択：
- プロジェクトを選択: `timeflow-app-[unique-id]`
- プラットフォーム: `android`, `ios`, `web` を選択
- アプリID: デフォルトのまま

### 2.4 Firebase設定ファイルの確認

設定完了後、以下のファイルが生成されることを確認：
```
lib/firebase_options.dart
android/app/google-services.json
ios/Runner/GoogleService-Info.plist
```

### 2.5 Firebaseサービスの有効化

Firebase Console（https://console.firebase.google.com/）で以下のサービスを有効化：

1. **Authentication**
   - 「Authentication」→「Sign-in method」
   - 「Google」を有効化
   - 「メール/パスワード」を有効化

2. **Firestore Database**
   - 「Firestore Database」→「データベースを作成」
   - テストモードで開始（後でセキュリティルールを設定）

3. **Storage**
   - 「Storage」→「始める」
   - テストモードで開始

4. **Analytics**
   - 既に有効化済み

## 3. CI/CDパイプライン構築

### 3.1 GitHub Actionsワークフローの作成

プロジェクトルートに `.github/workflows/` ディレクトリを作成：

```bash
mkdir -p .github/workflows
```

### 3.2 CI ワークフローファイルの作成

`.github/workflows/ci.yml` を作成：

```yaml
name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.19.0'
        
    - name: Install dependencies
      run: flutter pub get
      
    - name: Run code generation
      run: flutter packages pub run build_runner build --delete-conflicting-outputs
      
    - name: Analyze code
      run: flutter analyze
      
    - name: Run tests
      run: flutter test --coverage
      
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: coverage/lcov.info

  build-android:
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.19.0'
        
    - name: Install dependencies
      run: flutter pub get
      
    - name: Run code generation
      run: flutter packages pub run build_runner build --delete-conflicting-outputs
      
    - name: Build Android APK
      run: flutter build apk --release
      
    - name: Upload APK
      uses: actions/upload-artifact@v3
      with:
        name: release-apk
        path: build/app/outputs/flutter-apk/app-release.apk

  build-ios:
    needs: test
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.19.0'
        
    - name: Install dependencies
      run: flutter pub get
      
    - name: Run code generation
      run: flutter packages pub run build_runner build --delete-conflicting-outputs
      
    - name: Build iOS (No signing)
      run: flutter build ios --release --no-codesign
```

### 3.3 リリース用ワークフローの作成

`.github/workflows/release.yml` を作成：

```yaml
name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.19.0'
        
    - name: Install dependencies
      run: flutter pub get
      
    - name: Run code generation
      run: flutter packages pub run build_runner build --delete-conflicting-outputs
      
    - name: Run tests
      run: flutter test
      
    - name: Build Android APK
      run: flutter build apk --release
      
    - name: Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        draft: false
        prerelease: false
        
    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: build/app/outputs/flutter-apk/app-release.apk
        asset_name: timeflow-app.apk
        asset_content_type: application/vnd.android.package-archive
```

## 4. コードスタイル・Lint設定

### 4.1 analysis_options.yamlの更新

```yaml
include: package:very_good_analysis/analysis_options.yaml

analyzer:
  exclude:
    - "**/*.g.dart"
    - "**/*.freezed.dart"
  plugins:
    - custom_lint
    
linter:
  rules:
    # カスタムルール
    prefer_single_quotes: true
    avoid_print: true
    avoid_unnecessary_containers: true
    prefer_const_constructors: true
    prefer_const_literals_to_create_immutables: true
    sort_constructors_first: true
    sort_unnamed_constructors_first: true
    
    # Riverpod関連
    riverpod_final_provider: true
```

### 4.2 VS Code設定の作成

`.vscode/settings.json` を作成：

```json
{
  "dart.previewFlutterUiGuides": true,
  "dart.previewFlutterUiGuidesCustomTracking": true,
  "editor.formatOnSave": true,
  "editor.codeActionsOnSave": {
    "source.fixAll": true
  },
  "files.associations": {
    "*.dart": "dart"
  },
  "dart.lineLength": 120,
  "editor.rulers": [120],
  "files.exclude": {
    "**/*.g.dart": true,
    "**/*.freezed.dart": true
  }
}
```

### 4.3 VS Code拡張機能の推奨設定

`.vscode/extensions.json` を作成：

```json
{
  "recommendations": [
    "Dart-Code.flutter",
    "Dart-Code.dart-code",
    "ms-vscode.vscode-json",
    "bradlc.vscode-tailwindcss",
    "usernamehw.errorlens"
  ]
}
```

### 4.4 Gitフック設定（pre-commit）

プロジェクトルートに `scripts/pre-commit.sh` を作成：

```bash
#!/bin/bash

echo "Running pre-commit checks..."

# コード生成
echo "Running code generation..."
flutter packages pub run build_runner build --delete-conflicting-outputs

# フォーマット確認
echo "Checking code formatting..."
if ! flutter format --dry-run --set-exit-if-changed lib/ test/; then
    echo "Code is not formatted. Run 'flutter format lib/ test/' to fix."
    exit 1
fi

# 静的解析
echo "Running static analysis..."
if ! flutter analyze; then
    echo "Static analysis failed."
    exit 1
fi

# テスト実行
echo "Running tests..."
if ! flutter test; then
    echo "Tests failed."
    exit 1
fi

echo "Pre-commit checks passed!"
```

実行権限を付与：

```bash
chmod +x scripts/pre-commit.sh
```

Git hookを設定：

```bash
# pre-commitフックを設定
ln -sf ../../scripts/pre-commit.sh .git/hooks/pre-commit
```

## 5. 動作確認

### 5.1 基本設定の確認

```bash
# Flutter doctorで環境確認
flutter doctor

# 依存関係の確認
flutter pub deps

# 静的解析の実行
flutter analyze

# コード生成の確認
flutter packages pub run build_runner build
```

### 5.2 Firebase接続テスト

`lib/main.dart` を一時的に以下のように更新してFirebase接続を確認：

```dart
import 'package:flutter/material.dart';
import 'package:firebase_core/firebase_core.dart';
import 'firebase_options.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await Firebase.initializeApp(
    options: DefaultFirebaseOptions.currentPlatform,
  );
  runApp(MyApp());
}

class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'TimeFlow',
      theme: ThemeData(
        primarySwatch: Colors.blue,
      ),
      home: Scaffold(
        appBar: AppBar(title: Text('TimeFlow - Setup Complete')),
        body: Center(
          child: Text('Firebase Connected Successfully!'),
        ),
      ),
    );
  }
}
```

### 5.3 アプリの実行確認

```bash
# アプリを実行して動作確認
flutter run
```

## 6. 設定完了後のファイル構造

```
project-root/
├── .github/
│   └── workflows/
│       ├── ci.yml
│       └── release.yml
├── .vscode/
│   ├── settings.json
│   └── extensions.json
├── android/
│   └── app/
│       └── google-services.json
├── ios/
│   └── Runner/
│       └── GoogleService-Info.plist
├── lib/
│   └── firebase_options.dart
├── scripts/
│   └── pre-commit.sh
├── analysis_options.yaml
├── pubspec.yaml
└── pubspec.yaml.backup
```

## トラブルシューティング

### よくある問題と解決方法

1. **Firebase設定エラー**
   ```bash
   # Firebase設定をやり直す
   flutterfire configure --force
   ```

2. **依存関係の競合**
   ```bash
   # pub cacheをクリア
   flutter pub cache repair
   flutter clean
   flutter pub get
   ```

3. **コード生成エラー**
   ```bash
   # 強制的にコード生成をやり直す
   flutter packages pub run build_runner clean
   flutter packages pub run build_runner build --delete-conflicting-outputs
   ```

4. **Android ビルドエラー**
   ```bash
   # Android設定のクリーンアップ
   cd android
   ./gradlew clean
   cd ..
   flutter clean
   flutter pub get
   ```

## 次のステップ

Phase 1.1完了後、以下の手順に進みます：

1. **Phase 1.2**: アーキテクチャ基盤構築
2. **Phase 1.3**: 認証システム実装

各フェーズの詳細な手順書も必要に応じて作成可能です。